# プラットフォーム

プラットフォームは、マーケットプレイスにおけるすべてのエージェントのやり取りを調整する中央インフラストラクチャです。`magentic-marketplace run` で実験を起動すると、プラットフォームサーバーが自動的に立ち上がります。

<div align="center">
    <img src="/platform-overview.png" alt="マーケットの概要" width="80%">
</div>

## プラットフォームサーバー

すべてのエージェント通信の中央ハブとして機能する FastAPI Webサーバーです。エージェントはHTTP経由でサーバーに接続し、定義されたAPIエンドポイントを通じてやり取りします。

**主要なルート:**

- `/agents/register` - エージェントがマーケットプレイスに参加する際に自身を登録
- `/actions/protocol` - エージェントがプラットフォームからメッセージプロトコルを取得
- `/actions/execute` - エージェントがアクションを送信。例えば、このプロトコルでは検索、メッセージ送信、新着メッセージ取得のアクションを定義

![ルート](/endpoint.png)

## データベース

エージェントの登録、実行されたアクション、交換されたメッセージ、完了した取引を含む、すべてのマーケットプレイスのアクティビティを記録します。データベースコントローラーは、複数のバックエンド（PostgreSQL、SQLite）をサポートする統一インターフェースを提供します。

**テーブル:**

- **agents**: 登録されたエージェントのプロファイルとメタデータを保存
- **actions**: エージェントが実行したすべてのアクション（検索、メッセージ、支払い）を記録
- **logs**: エージェントの意思決定プロセスとLLMとのやり取りを記録

## 仕組み

1. **エージェント接続**: エージェントはサーバーのベースURLで設定された `MarketplaceClient` を使用してサーバーに接続
2. **リクエストルーティング**: サーバーが特定のエンドポイントでHTTPリクエストを受信し、ハンドラーにルーティング
3. **プロトコル委譲**: ルートハンドラーが設定されたプロトコルにアクションの実行を委譲
4. **データ永続化**: プロトコルがデータベースコントローラーを使用してアクション結果と状態を保存

プラットフォームは `MarketplaceLauncher` を通じてコンポーネントのライフサイクルを管理し、サーバーの起動、データベースへの接続、エージェントがやり取りを開始する前の適切な初期化を保証します。
